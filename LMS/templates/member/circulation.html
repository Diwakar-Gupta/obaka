{% extends 'member/base.html' %}

{% block content %}

<table class="table" style="text-align: center;">

  <thead>
    <tr>
      <th>Date</th>
      <th>Title</th>
      <th>Author</th>
      <th>Barcode</th>
      <th>Number of renewals</th>
      <th>Checked out on</th>
      <th>Checked out from</th>
      <th>Date due</th>
      <th>Return date</th>
    </tr>
  </thead>

  <tbody id="circulations">
    {% for issue in issues%}

    <tr>
      <td>
        <span>{{issue.date}}</span>
      </td>
      <td><a href="#">{{issue.book.title}}</a></td>

      <td>{{issue.book.author}}</td>
      <td><a target="_blank" href="/admin/LMS/isbn/{{ issue.book.isbn }}/change">{{issue.book.isbn}}</a></td>
      <td>{{issue.countrenewal}}</td>
      <td>
        <span>{{ issue.issued_time }}</span>
      </td>
      <td>{{ issue.issuefrom }}</td>
      <td>
        <span>{{ issue.duedate }}</span>
      </td>
      <td>
        {% if issue.is_returned %}
        <span>Checked out</span>
        {% else %}
        <span>{{ issue.return_date }}</span>
        {% endif %}
      </td>
    </tr>

    {% endfor %}

  </tbody>

</table>

<script>

let infiniteLoopWorking = false;
    document.getElementById('content').onscroll = function () {
        c = document.getElementById('content')
        if (c.scrollHeight - c.offsetHeight - c.scrollTop == 0 && infiniteLoopWorking == false) {
            infiniteLoopWorking = true;
            $.ajax({
                type: 'GET',
                url: '',
                data: {
                    'have': document.getElementById('circulations').children.length
                },
                success: function (data) {
                    list = JSON.parse(data);
                    if (list == false)
                        makeToast('No more circulations');
                    else {
                        table = document.getElementById('circulations');

                        list.forEach(function (e) {
                            table.innerHTML += '<tr>'+
      '<td>'+
        '<span>'+e.date+'</span>'+
      '</td>'+
      '<td><a href="#">'+e.title+'</a></td>'+
      '<td>'+e.author+'</td>'+
      '<td><a target="_blank" href="/admin/LMS/isbn/'+ e.barcode +'/change">'+ e.barcode +'</a></td>'+
      '<td>'+e.countrenewal+'</td>'+
      '<td>'+
        '<span>'+ e.issued_time +'</span>'+
      '</td>'+
     '<td>'+ e.issuefrom +'</td>'+
      '<td>'+
        '<span>'+ e.duedate +'</span>'+
      '</td>'+
      '<td>'+
        e.return_date
      '</td>'+
    '</tr>'
                        })
                    }

                    setTimeout(function () {
                        infiniteLoopWorking = false
                    }, 500);
                },
                error: function (data) {
                    makeToast('Cant connect to server','error');
                }
            });
        }
    }

</script>

{% endblock %}